# CLI Interactive Mode Guide

`cli_interactive` は、ぷよぷよをターミナル上でインタラクティブにプレイできるツールです。AIのサジェスト機能、Undo機能、連鎖アニメーション、puyop.com連携など、学習に役立つ機能が充実しています。

## 目次

1. [基本的な使い方](#基本的な使い方)
2. [操作方法](#操作方法)
3. [主な機能](#主な機能)
4. [puyop.com連携](#puyopcom連携)
5. [画面の見方](#画面の見方)
6. [活用例](#活用例)

## 基本的な使い方

### 通常起動（空の盤面から開始）

```bash
cargo run --release -p ghoti-simulator --bin cli_interactive
```

### puyop.com URLから盤面を読み込んで起動

```bash
# URLを引数として渡す
cargo run --release -p ghoti-simulator --bin cli_interactive "https://puyop.com/s/420Aa9r9hj"

# または短縮形式
cargo run --release -p ghoti-simulator --bin cli_interactive "420Aa9r9hj"
```

## 操作方法

| キー | 動作 |
|------|------|
| **a** / **d** | ぷよを左右に移動 |
| **j** / **k** | ぷよを左回転/右回転 |
| **s** / **Space** | ハードドロップ（ぷよを落とす） |
| **u** | 1手前に戻る（Undo） |
| **h** | 詳細なAIサジェストを表示 |
| **q** | ゲーム終了 |

## 主な機能

### 1. リアルタイムAIサジェスト表示

画面右側に常時、AIが推奨する手を表示します：

```
🤖 AI Suggestions:
1st: Col 3 Rot 0 (Eval: 1250)
2nd: Col 4 Rot 1 (Eval: 1180)
3rd: Col 2 Rot 0 (Eval: 1050)
...
```

- **1st〜6th**: 評価値の高い順に6つの候補手を表示
- **Col**: 配置する列（1〜6）
- **Rot**: 回転数（0:縦上, 1:横右, 2:縦下, 3:横左）
- **Eval**: BeamSearchAIによる評価値

### 2. Undo機能

- **u**キーを押すと、1手前の状態に即座に戻ります
- 最大50手分の履歴を保持
- 中間画面なしでスムーズに遷移
- 履歴がない場合は何も起こりません

### 3. 連鎖アニメーション

連鎖が発生すると、自動的にステップごとのアニメーションを表示：

1. ぷよ設置直後の状態
2. 連鎖開始前の状態（連鎖数を表示）
3. 全連鎖完了後の最終状態とスコア

任意のキーで次のステップへ進み、**q**でアニメーションをスキップできます。

### 4. puyop.com URL連携

#### 現在の盤面をURLとして表示

画面上部に常時表示される：

```
📋 Puyop URL: https://puyop.com/s/420Aa9r9hj
```

このURLをコピーしてブラウザで開くと、puyop.comの連鎖シミュレータで同じ盤面を確認できます。

#### URLから盤面を読み込み

起動時にコマンドライン引数でpuyop.com URLを指定すると、その盤面から開始できます。

## 画面の見方

```
============================================================
Turn: 15  Score: 2480
============================================================
📋 Puyop URL: https://puyop.com/s/420Aa9r9hj
============================================================

       ●                    🤖 AI Suggestions:
    ●  ●                    1st: Col 3 Rot 0 (Eval: 1250)
                           2nd: Col 4 Rot 1 (Eval: 1180)
  1 2 3 4 5 6
 ┌─────────────┐           3rd: Col 2 Rot 0 (Eval: 1050)
 │· · · · · · │           4th: Col 5 Rot 2 (Eval: 980)
 │· · · · · · │           5th: Col 1 Rot 0 (Eval: 920)
 │· · · · · · │           6th: Col 6 Rot 3 (Eval: 850)
 │· · · · · ● │
 │· ● · · ● ● │
 │● ● ● ● ● ● │
 │● ● ● ● ● ● │
 └─────────────┘

Next puyos:
  Next   : ●●
  2nd    : ●●

Position: Column 3, Rotation 0 (vertical ↑)
```

### 画面要素の説明

1. **ヘッダー部**: ターン数とスコア
2. **Puyop URL**: 現在の盤面のpuyop.com URL
3. **フィールド**:
   - 左側：メインの盤面（6×13）
   - 上部：現在操作中のぷよ
4. **AIサジェスト**: 右側に推奨手を常時表示
5. **Next puyos**: 次のツモ（最大2手先まで）
6. **Position**: 現在のカーソル位置と回転状態

## 活用例

### 1. 特定の局面の練習

```bash
# GTRの土台を作った状態から練習
cargo run --release -p ghoti-simulator --bin cli_interactive "https://puyop.com/s/[GTRのURL]"
```

### 2. AIの手筋を学ぶ

1. 自分で手を選ぶ前に、右側のAIサジェストを確認
2. なぜその手が良いのか考える
3. 実際に置いてみて結果を確認
4. 間違えたら**u**で戻してやり直し

### 3. 連鎖の組み方を学習

1. 連鎖が発生すると自動でアニメーション表示
2. どのように連鎖が繋がるかを視覚的に確認
3. puyop.com URLをコピーして、ブラウザでも確認可能

### 4. 友達と盤面を共有

1. 面白い局面ができたら、画面上部のpuyop.com URLをコピー
2. URLを友達に送って同じ局面から始めてもらう
3. 誰が良い連鎖を組めるか競争

### 5. 配ぷよ検証

特定の配ぷよ（初手AA-ABなど）の最適な積み方を研究：

1. puyop.comで初手を組んでURLを取得
2. cli_interactiveで読み込み
3. AIサジェストを見ながら最適解を学習

## トラブルシューティング

### URLが正しく読み込まれない

- URLが正しいフォーマットか確認（`https://puyop.com/s/` または `http://www.puyop.com/s/`）
- エンコード文字列のみ（例：`420Aa9r9hj`）でも可能

### 画面が崩れる

- ターミナルのサイズを十分に大きくする（推奨：幅80文字以上、高さ30行以上）
- フォントサイズを調整する

### 色が表示されない

- ターミナルがANSIカラーに対応しているか確認
- iTerm2、Windows Terminal、VS Code内蔵ターミナルなどの使用を推奨

## 今後の改善予定

- [ ] 連鎖アニメーションの詳細化（1連鎖ごとのステップ表示）
- [ ] 配ぷよのカスタマイズ機能
- [ ] リプレイの保存・再生機能
- [ ] より詳細な統計情報の表示
- [ ] マルチプレイヤー対戦機能

## 関連ドキュメント

- [ANALYZE_POSITION_GUIDE.md](./ANALYZE_POSITION_GUIDE.md) - 局面解析ツールの使い方
- [PUYOP_DECODER_GUIDE.md](./PUYOP_DECODER_GUIDE.md) - puyop.comデコーダーの詳細
- [プロジェクトREADME](../README.md) - プロジェクト全体の概要

## コントリビューション

機能追加や改善のアイデアがありましたら、GitHubのIssueまたはPull Requestでお知らせください。

---

*Last updated: 2024*